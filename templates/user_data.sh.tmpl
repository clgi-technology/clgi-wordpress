#!/bin/bash
set -e

echo "üì¶ Bootstrapping VM for deployment mode: ${deployment_mode}"

# Detect package manager and install Python3 and dependencies
if command -v yum >/dev/null 2>&1; then
  echo "Using yum package manager"
  yum update -y
  yum install -y python3 python3-pip curl
elif command -v apt-get >/dev/null 2>&1; then
  echo "Using apt-get package manager"
  apt-get update
  apt-get install -y python3 python3-pip curl
else
  echo "Unsupported package manager. Exiting."
  exit 1
fi

pip3 install requests beautifulsoup4

mkdir -p /home/ec2-user/scripts
cd /home/ec2-user/scripts

# Download provisioning scripts from GitHub
SCRIPTS_URL="https://raw.githubusercontent.com/clgi-technology/clgi-wordpress/main/scripts"

echo "‚¨áÔ∏è Downloading scripts from $SCRIPTS_URL"
curl -O "$SCRIPTS_URL/install-django.sh"
curl -O "$SCRIPTS_URL/install-wordpress.sh"
curl -O "$SCRIPTS_URL/install-clgi.sh"
chmod +x install-*.sh

# Run the installer based on deployment mode
if [ "${deployment_mode}" = "sandbox" ]; then
  echo "‚öôÔ∏è Installing Django stack..."
  ./install-django.sh
else
  echo "‚öôÔ∏è Installing WordPress stack..."
  ./install-wordpress.sh
fi

# Optionally clone CLGI.org HTML
%{ if setup_demo_clone == "true" }
echo "üåê Cloning demo content from: ${clone_target_url}"
./install-clgi.sh
%{ endif }

echo "‚úÖ Provisioning complete."
