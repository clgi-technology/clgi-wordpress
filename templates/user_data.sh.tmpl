#!/bin/bash
set -euxo pipefail

LOG_FILE="/var/log/clgi-provisioning.log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "üì¶ Bootstrapping VM for deployment mode: ${deployment_mode}"

# Detect package manager and install system packages
if command -v yum >/dev/null 2>&1; then
  echo "Using yum package manager"
  yum update -y
  yum install -y python3 python3-pip curl dos2unix
elif command -v apt-get >/dev/null 2>&1; then
  echo "Using apt-get package manager"
  apt-get update
  apt-get install -y python3 python3-pip curl dos2unix
else
  echo "‚ùå Unsupported package manager. Exiting."
  exit 1
fi

# Upgrade pip and install Python dependencies
pip3 install --upgrade pip
pip3 install requests beautifulsoup4

# Create working directory
mkdir -p /home/ec2-user/scripts
cd /home/ec2-user/scripts

# Write install-django.sh inline for reliability
cat > install-django.sh <<'EOF'
#!/bin/bash
set -euxo pipefail

echo "üì¶ Installing Django"

# Install development tools
if command -v yum >/dev/null 2>&1; then
  yum install -y gcc python3-devel
elif command -v apt-get >/dev/null 2>&1; then
  apt-get install -y build-essential python3-dev
fi

# Create virtual environment
cd /opt
python3 -m venv django_env
source django_env/bin/activate

# Install Django
pip install --upgrade pip
pip install django gunicorn

# Start a Django project
django-admin startproject mysite
cd mysite

# Run migrations
python manage.py migrate

# Start dev server (in background)
nohup python manage.py runserver 0.0.0.0:8000 &

echo "‚úÖ Django installed at /opt/mysite"
EOF

chmod +x install-django.sh

# Download other scripts from GitHub (with fallback logic)
scripts_url="https://raw.githubusercontent.com/clgi-technology/clgi-wordpress/main/scripts"
download_script() {
  local script_name=$1
  if curl --fail -sO "${scripts_url}/${script_name}"; then
    echo "‚úÖ Downloaded ${script_name}"
    dos2unix "${script_name}"
    chmod +x "${script_name}"
  else
    echo "‚ö†Ô∏è Failed to download ${script_name}, skipping."
  fi
}

download_script install-wordpress.sh
download_script install-clgi.sh

# Run the appropriate installer
if [[ "${deployment_mode}" == "sandbox" ]]; then
  echo "‚öôÔ∏è Installing Django stack..."
  ./install-django.sh
else
  echo "‚öôÔ∏è Installing WordPress stack..."
  if [[ -f install-wordpress.sh ]]; then
    ./install-wordpress.sh
  else
    echo "‚ùå install-wordpress.sh not available. Aborting."
    exit 1
  fi
fi

# Optionally run content setup
%{ if setup_demo_clone != "none" }
echo "üåê Cloning demo content: ${setup_demo_clone} from ${clone_target_url}"
if [[ -f install-clgi.sh ]]; then
  ./install-clgi.sh "${setup_demo_clone}"
else
  echo "‚ùå install-clgi.sh not available. Skipping clone."
fi
%{ endif }

echo "‚úÖ Provisioning complete."
