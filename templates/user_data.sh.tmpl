#!/bin/bash
set -euo pipefail

echo "Starting user data script..."

# Update and install dependencies
/usr/bin/apt-get update
/usr/bin/apt-get install -y apache2 php libapache2-mod-php php-mysql unzip curl wget

# Enable and start Apache
/usr/bin/systemctl enable apache2
/usr/bin/systemctl start apache2

# Wait a few seconds to ensure Apache is running
sleep 5

echo "Removing default Apache site content..."
rm -rf /var/www/html/*

if [ "${setup_demo_clone}" = "true" ]; then
  echo "Cloning demo site from ${clone_target_url}..."
  /usr/bin/wget --mirror --convert-links --adjust-extension --page-requisites --no-parent "${clone_target_url}" -P /var/www/html

  echo "Setting ownership and permissions for cloned site..."
  /bin/chown -R www-data:www-data /var/www/html
  /bin/chmod -R 755 /var/www/html

else
  echo "Downloading and installing latest WordPress..."
  cd /tmp
  /usr/bin/curl -O https://wordpress.org/latest.tar.gz
  /bin/tar -xzf latest.tar.gz
  /bin/cp -r wordpress/* /var/www/html/
  
  echo "Setting ownership and permissions for WordPress..."
  /bin/chown -R www-data:www-data /var/www/html
  /bin/chmod -R 755 /var/www/html
fi

echo "Restarting Apache..."
/usr/bin/systemctl restart apache2

echo "User data script completed."
