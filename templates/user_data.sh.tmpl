#!/bin/bash
set -e

echo "üì¶ Bootstrapping VM for deployment mode: ${deployment_mode}"

# Install Python and dependencies for cloning script
apt-get update
apt-get install -y python3 python3-pip
pip3 install requests beautifulsoup4

mkdir -p /home/ubuntu/scripts
cd /home/ubuntu/scripts

# Download provisioning scripts from GitHub
SCRIPTS_URL="https://raw.githubusercontent.com/clgi-technology/clgi-wordpress/main/scripts"

echo "‚¨áÔ∏è Downloading scripts from $SCRIPTS_URL"
curl -O "$SCRIPTS_URL/install-django.sh"
curl -O "$SCRIPTS_URL/install-wordpress.sh"
curl -O "$SCRIPTS_URL/install-clgi.sh"
chmod +x install-*.sh

# Run the installer based on deployment mode
if [ "${deployment_mode}" = "sandbox" ]; then
  echo "‚öôÔ∏è Installing Django stack..."
  ./install-django.sh
else
  echo "‚öôÔ∏è Installing WordPress stack..."
  ./install-wordpress.sh
fi

# Optionally clone CLGI.org HTML
%{ if setup_demo_clone == "true" }
echo "üåê Cloning demo content from: ${clone_target_url}"
./install-clgi.sh
%{ endif }

echo "‚úÖ Provisioning complete."
