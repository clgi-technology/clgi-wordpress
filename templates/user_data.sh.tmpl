#!/bin/bash
set -e

echo "üì¶ Bootstrapping VM for deployment mode: ${deployment_mode}"

# Detect package manager and install Python3 and dependencies
if command -v yum >/dev/null 2>&1; then
  echo "Using yum package manager"
  yum update -y
  yum install -y python3 python3-pip curl dos2unix
elif command -v apt-get >/dev/null 2>&1; then
  echo "Using apt-get package manager"
  apt-get update
  apt-get install -y python3 python3-pip curl dos2unix
else
  echo "Unsupported package manager. Exiting."
  exit 1
fi

pip3 install requests beautifulsoup4

mkdir -p /home/ec2-user/scripts
cd /home/ec2-user/scripts

# Download provisioning scripts from GitHub
SCRIPTS_URL="https://raw.githubusercontent.com/clgi-technology/clgi-wordpress/main/scripts"

echo "‚¨áÔ∏è Downloading scripts from \${SCRIPTS_URL}"
curl -O "\${SCRIPTS_URL}/install-django.sh"
curl -O "\${SCRIPTS_URL}/install-wordpress.sh"
curl -O "\${SCRIPTS_URL}/install-clgi.sh"

# Ensure scripts use Unix-style line endings
dos2unix install-*.sh

chmod +x install-*.sh

# Run the installer based on deployment mode
if [ "${deployment_mode}" = "sandbox" ]; then
  echo "‚öôÔ∏è Installing Django stack..."
  ./install-django.sh
else
  echo "‚öôÔ∏è Installing WordPress stack..."
  ./install-wordpress.sh
fi

# Optionally clone CLGI.org HTML
%{ if setup_demo_clone != "none" }
echo "üåê Cloning demo content from: ${clone_target_url} with mode: ${setup_demo_clone}"
./install-clgi.sh ${setup_demo_clone}
%{ endif }

echo "‚úÖ Provisioning complete."
