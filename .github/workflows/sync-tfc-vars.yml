      - name: Upsert Env Variables
        shell: bash
        run: |
          upsert_var() {
            key="$1"
            value="$2"
            sensitive="$3"
            workspace_id="${{ steps.workspace_id.outputs.WORKSPACE_ID }}"

            VAR_ID=$(curl -sS \
              --header "Authorization: Bearer $TFC_TOKEN" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/workspaces/$workspace_id/vars" | jq -r --arg key "$key" '.data[] | select(.attributes.key == $key and .attributes.category == "env") | .id')

            if [[ -n "$VAR_ID" && "$VAR_ID" != "null" ]]; then
              curl -sS --request PATCH \
                --header "Authorization: Bearer $TFC_TOKEN" \
                --header "Content-Type: application/vnd.api+json" \
                --data @- "https://app.terraform.io/api/v2/workspaces/$workspace_id/vars/$VAR_ID" <<EOF
{
  "data": {
    "id": "$VAR_ID",
    "type": "vars",
    "attributes": {
      "key": "$key",
      "value": "$value",
      "category": "env",
      "hcl": false,
      "sensitive": $sensitive
    }
  }
}
EOF
            else
              curl -sS --request POST \
                --header "Authorization: Bearer $TFC_TOKEN" \
                --header "Content-Type: application/vnd.api+json" \
                --data @- "https://app.terraform.io/api/v2/workspaces/$workspace_id/vars" <<EOF
{
  "data": {
    "type": "vars",
    "attributes": {
      "key": "$key",
      "value": "$value",
      "category": "env",
      "hcl": false,
      "sensitive": $sensitive
    }
  }
}
EOF
            fi
          }

          echo "Syncing AWS_ACCESS_KEY_ID"
          upsert_var "AWS_ACCESS_KEY_ID" "$AWS_ACCESS_KEY_ID" true

          echo "Syncing AWS_SECRET_ACCESS_KEY"
          upsert_var "AWS_SECRET_ACCESS_KEY" "$AWS_SECRET_ACCESS_KEY" true

          if [[ -n "$AWS_SESSION_TOKEN" && "$AWS_SESSION_TOKEN" != "null" ]]; then
            echo "Syncing AWS_SESSION_TOKEN"
            upsert_var "AWS_SESSION_TOKEN" "$AWS_SESSION_TOKEN" true
          fi
